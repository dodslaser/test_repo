# Create or update a release PR for merging dev -> main
---
  name: Publish Release

  on:
    pull_request_target:
      types: [closed]

  jobs:
    version:
      runs-on: ubuntu-latest
      if: github.event.pull_request.merged == true
      outputs:
        current: ${{ steps.semver.outputs.current }}
        next: ${{ steps.semver.outputs.next }}
      steps:
      - uses: actions/checkout@v4
      - uses: ietf-tools/semver-action@v1
        id: semver
        with:
          token: ${{ github.token }}
          branch: ${{ github.event.pull_request.base.ref }}
          noVersionBumpBehavior: 'patch'

    bump-pyproject-version:
      runs-on: ubuntu-latest
      if: github.event.pull_request.merged == true
      needs: [version]
      steps:
        - uses: actions/checkout@v4
        - name: poetry-version
          run: |
            pipx install poetry
            poetry version -- ${{ needs.version.outputs.next }}
        - name: git-commit
          run: |
            git config --global user.email ""
            git config --global user.name "github-actions[bot]"
            git commit -am "chore: Bump version (${{ needs.version.outputs.current }} -> ${{ needs.version.outputs.next }})"

    publish-release:
      runs-on: ubuntu-latest
      if: github.event.pull_request.merged == true
      needs: [version]
      permissions:
        contents: write
      steps:
        - uses: actions/checkout@v4
        - name: publish-release
          env:
            GH_TOKEN: ${{ github.token }}
          run: |
            gh release create '${{ needs.version.outputs.next }}' \
              --notes '${{ github.event.pull_request.body }}' \
              --title '${{ needs.version.outputs.next }}'
